<?php include 'header.php';/////////////// GETTERSfunction getConversationByIdRecipient($id_recipient){	global $userid;	$sql = 'SELECT id, date	FROM private_messages	WHERE id_sender ='.$userid.'	AND id_recipient ='.$id_recipient.'	UNION ALL SELECT id, date	FROM private_messages	WHERE id_sender ='.$id_recipient.'	AND id_recipient ='.$userid.'	ORDER BY date DESC';	$query = mysql_query($sql);		if(!$query || mysql_num_rows($query)<1) return false;		$conversation;	while ($result = mysql_fetch_assoc($query)){		$conversation[]= $result['id'];	}	return $conversation;}function getDialogers(){	global $userid;//global $message;	/*$sql ='SELECT id_sender, date FROM private_messages WHERE id_recipient='.$userid.'	UNION DISTINCT	SELECT id_recipient, date FROM private_messages WHERE id_sender ='.$userid.' ORDER BY date DESC';*/	$sql ='SELECT id_sender FROM private_messages WHERE id_recipient='.$userid.'	UNION DISTINCT	SELECT id_recipient FROM private_messages WHERE id_sender ='.$userid;		$query = mysql_query($sql);	if(!$query || mysql_num_rows($query)<1) return false;		$dialogers;	while ($result = mysql_fetch_assoc($query)){		$dialogers[]= $result['id_sender'];  //$message.= 'dialoger: '.$result['id_sender'].'<br/>';	}		$resultat;	for($i=count($dialogers)-1; $i>=0; $i--){		$resultat[] = $dialogers[$i];	}		return $resultat;}function getLastMessageIdOfConversationByOtherUser($user){	global $userid;	$sql= '	SELECT id, date FROM private_messages WHERE id_sender='.$userid.' AND id_recipient='.$user.'	UNION ALL	SELECT id, date FROM private_messages WHERE id_sender=1 AND id_recipient='.$userid.'	ORDER BY date DESC	LIMIT 0,1';		$query = mysql_query($sql);	if(!$query || mysql_num_rows($query)<1) return false;	$result = mysql_fetch_assoc($query);	return $result['id'];}function isSender($user, $idmessage){	$sql = 'SELECT id_sender FROM private_messages WHERE id='.$idmessage;	$query = mysql_query($sql);		if(!$query) return false;		$result = mysql_fetch_assoc($query);	return $result['id_sender'] == $user;}/////////////// PRINTERSfunction printAvatarByUserId($id){ // display avatar miniature	$sql = 'SELECT avatar FROM users WHERE id='.$id;	$query = mysql_query($sql);	$result = mysql_fetch_assoc($query);	return '<img src="'.$result['avatar'].'"  width="64" height="64" alt="avatar">';}function printPMById($idpm){ // display one single message by message ID	$sql = 'SELECT * FROM private_messages WHERE id='.$idpm;	$query = mysql_query($sql);	if(!$query) return false;	$result = mysql_fetch_assoc($query);		$id_sender = $result['id_sender'];	$id_recipient = $result['id_recipient'];	$message = $result['message'];	$date = $result['date'];		$ficelle = '<table style="text-align: left; " border="0" cellpadding="2" cellspacing="2"><tr>';	$ficelle.= '<td>'.printAvatarByUserId($id_sender).'</td>';	$ficelle.= '<td>From: '.printLinkToProfileByUserId($id_sender).'<br/>'.$message;	//$ficelle.= '</td><td style="text-align: right; ">'.$date.'</td>'; DATE in another case	$ficelle.= '<br/>'.$date.'</td></tr>';	$ficelle.= '</table>';		return $ficelle;}function printAllPMByIdRecipient($id_recipient){ // display lastest messages of a conversation	$allpm = getConversationByIdRecipient($id_recipient);		if($allpm==false) return 'No message';		$ficelle ='';	foreach($allpm AS $pm){		$ficelle.=printPMById($pm).'<hr/>';	}	return $ficelle;}function printNewPMByIdRecipient($id_recipient){ // display new message form 	$ficelle ='<form action="private_messages.php?id_recipient='.$id_recipient.'" method="POST" >';	$ficelle.= '<table style="text-align: left; " border="0" cellpadding="2" cellspacing="2">';	$ficelle.= '<td style="text-align: right; "> To:</td><td>'.printLinkToProfileByUserId($id_recipient).'</td></tr>';	$ficelle.= '<td style="text-align: right; "> Message:</td><td><textarea name="newpm" id="newpm" /></textarea></td></tr>';	$ficelle.= '<tr><td></td><td><input type="submit" value="Send" /></td></tr></table></form>';	return $ficelle;}function printDiscussionByMessageId($id_message){	global $userid;	$sql = 'SELECT * FROM private_messages WHERE id='.$id_message;	$query = mysql_query($sql);	$ficelle = '';//$sql;//'';'';		if(!$query || mysql_num_rows($query)<1) return $ficelle;		$result = mysql_fetch_assoc($query);		$ficelle.= '<table style="text-align: left; " border="0" cellpadding="2" cellspacing="2"><tr>';		if(isSender($userid, $id_message)){		$ficelle.= '<td>'.printAvatarByUserId($result['id_recipient']).'</td>		<td>You have sent from '.printLinkToProfileByUserId($result['id_recipient']).':<br/><a href="private_messages.php?id_recipient='.$result['id_recipient'].'" >';	}else{		$ficelle.= '<td>'.printAvatarByUserId($result['id_sender']).'</td>		<td>You have received to '.printLinkToProfileByUserId($result['id_sender']).':<br/><a href="private_messages.php?id_recipient='.$result['id_sender'].'" >';			}		$ficelle.= $result['message'].'</a>';	//$ficelle.= '</td><td>'.$result['date'].'</td></tr></table>'; date in an other case	$ficelle.= '<br/>'.$result['date'].'</td></tr></table>';		return $ficelle;}function printLastestDiscussions(){	$ficelle = '';	$dialogers = getDialogers();	if($dialogers == false){ // no discussion 		$ficelle.= 'No message';		}else{		foreach($dialogers AS $single){			$ficelle.= '<hr/>'.printDiscussionByMessageId(getLastMessageIdOfConversationByOtherUser($single));		}			}		return $ficelle;}////////////////////// END FUNCTIONSif(isConnected($userid)){ // logged in	$html = ''; // God !		if(isset($_GET['id_recipient']) && belongsToUserGroups($userid, $_GET['id_recipient']) && $userid!=$_GET['id_recipient']){ // view chats with id_recipient			if($_POST){ // something to treat?			if(isset($_POST['newpm']) && $_POST['newpm']!=''){ // new pm 				$sql = 'INSERT INTO private_messages(id_sender, id_recipient, message) 				VALUES('.$userid.', '.$_GET['id_recipient'].', "'.$_POST['newpm'].'")';				$query = mysql_query($sql); // sending message				if (!$query) $message = 'Sending message failed';			}		}			$html.= '<h3>Private messages</h3><br/><br/>';		$html.= printNewPMByIdRecipient($_GET['id_recipient']).'<br/><br/><h4>Latest messages</h4><br/>';		$html.= printAllPMByIdRecipient($_GET['id_recipient']);				}else{ // view General			$html.= '<h2>Private Messages</h2><br/>			<h4>Latest discussions</h4>'.			printLastestDiscussions();		}		printDocument('Private messages');	}elseif($userid==$_GET['id_recipient']){		header('Location: private_messages.php');	}else{ // visitors		$html='';		$html.= RegistrationForVisitors();		printDocument('Sign up now!');}?>